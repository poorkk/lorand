---
title: 工作 透明加密
date: 2023-01-01 16:03:37
categories:
    - 工作
tags:
    - 工作
---

pg-internal.vonng.com



## 1.2 执行流程
1. postmater进程
2. postgres进程
    1. 存储接口：
    2. 事务模块：
    3. xlog模块：
    4. 共享缓冲区:
3. wal写进程
4. bgwriter进程
5. checkpoint进程：
6. vacuum进程：
7. 日志归档进程：

## 1.2 进程启动时机
```c
#define StartupDataBase()		StartChildProcess(StartupProcess)
#define StartBackgroundWriter() StartChildProcess(BgWriterProcess)
#define StartCheckpointer()		StartChildProcess(CheckpointerProcess)
#define StartWalWriter()		StartChildProcess(WalWriterProcess)
#define StartWalReceiver()		StartChildProcess(WalReceiverProcess)

main()
    PostmasterMain()
        pqsignal(SIGUSR1, sigusr1_handler); // 注册wal接受进程信号量
        SysLogger_Start()
        StartupDataBase() -> StartupProcessMain() // 启动进程：故障恢复
        ServerLoop()
            BackendStartup()
            SysLogger_Start()
            StartCheckpointer() -> CheckpointerMain() // 检查点进程
            StartBackgroundWriter() -> BackgroundWriterMain() // 数据写进程
            StartWalWriter() -> InitXLOGAccess() WalWriterMain() // wal写进程
            StartAutoVacLauncher() // 清理进程
            pgstat_start() // 状态检查进程
            pgarch_start() // 归档进程
            maybe_start_bgworker()

WaitForWALToBecomeAvailable()
    RequestXLogStreaming()
        SendPostmasterSignal(PMSIGNAL_START_WALRECEIVER)
sigusr1_handler(PMSIGNAL_START_WALRECEIVER)
    StartWalReceiver()

StartChildProcess()
    AuxiliaryProcessMain()
        WalWriterMain()
        ...
```

## 1.3 进程功能
### 1 启动进程


### 2 wal写进程

# 2 机制
## 2.1 故障恢复


## 2.2 checkpoint
```c
// checkpoint时机
#define CHECKPOINT_IS_SHUTDOWN	0x0001	/* Checkpoint is for shutdown */
#define CHECKPOINT_END_OF_RECOVERY	0x0002 /* end of wal end recovery */
#define CHECKPOINT_IMMEDIATE	0x0004	/* Do it without delays */
#define CHECKPOINT_FORCE		0x0008	/* Force even if no activity */
#define CHECKPOINT_FLUSH_ALL	0x0010	/* Flush all pages, including those belonging to unlogged tables */
/* These are important to RequestCheckpoint */
#define CHECKPOINT_WAIT			0x0020	/* Wait for completion */
/* These indicate the cause of a checkpoint request */
#define CHECKPOINT_CAUSE_XLOG	0x0040	/* XLOG consumption */
#define CHECKPOINT_CAUSE_TIME	0x0080	/* Elapsed time */

// checkpont实现
CheckpointerMain()
    for (;;) {
        ResetLatch()
        GetInsertRecPtr()
        CreateCheckPoint()
            InitXLogInsert()
            smgrpreckpt()
            GetOldestActiveTransactionId()
            WALInsertLockAcquireExclusive()
            WALInsertLockRelease()
            MultiXactGetCheckptMulti()

            // 先落盘
            CheckPointGuts()
                CheckPointCLOG()
                CheckPointCommitTs()
                CheckPointSUBTRANS()
                CheckPointMultiXact()
                CheckPointPredicate()
                CheckPointRelationMap()
                CheckPointReplicationSlots()
                CheckPointSnapBuild()
                CheckPointLogicalRewriteHeap()
                CheckPointBuffers()
                    BufferSync()
                        while() {
                            SyncOneBuffer()
                                FlushBuffer()
                                    XLogFlush()
                                    smgrwrite()
                        }
                    smgrsync()
                CheckPointReplicationOrigin()
                CheckPointTwoPhase()

            // 再写xlog记录
            XLogBeginInsert()
            XLogRegisterData()
            XLogInsert(RM_XLOG_ID)
            XLogFlush()
            // 最后更新控制文件
            UpdateControlFile()
            smgrpostckpt()

        smgrcloseall()

        CheckArchiveTimeout()
        pgstat_send_bgwriter()
        WaitLatch()
    }

// BufferSync
```

# 3 模块
## 3.1 恢复

## 3.1 磁盘介质管理

### xlog接口
```c
// 插入
XLogRecPtr XLogInsertRecord(struct XLogRecData *rdata, XLogRecPtr fpw_lsn)
// 落盘
XLogFlush(XLogRecPtr RecPtr)
xlog_redo(XLogReaderState *record)

XLogRecPtr GetXLogReplayRecPtr()
XLogRecPtr GetXLogInsertRecPtr()
XLogRecPtr GetXLogWriteRecPtr()

UpdateControlFile()

StartupXLOG()
ShutdownXLOG()
WakeupRecovery()

```
