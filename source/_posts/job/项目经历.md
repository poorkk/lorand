---
title: 工作 透明加密
date: 2023-01-01 16:03:37
categories:
    - 工作
tags:
    - 工作
---

# 1 项目经历
## 1.1 透明加密
### 功能
首先用户配置密钥信息，并在创建表时指定表是否需被加密，之后，数据库将加密表的数据写入磁盘前，会自动对数据加密，从磁盘读取加密表的数据时，自动对数据解密。
### 实现思路
实现透明加密主要分为五步。
1. 配置透明加密：从内核角度，密钥分为主密钥和数据密钥。数据密钥用于加密表中数据，主密钥加密数据密钥。数据密钥密文由数据存储，主密钥由华为云kms等外部密钥管理者存储；
2. 创建加密表：通过语法创建加密表时，自动生成数据密钥，并通过主密钥将其加密存储在pg_class系统表中；
3. 初始化数据页：如果数据页属于加密表，在数据页的flag进行标记。并在xlog中记录密钥信息，备机重放xlog时需使用到密钥信息。
4. 落盘数据页：根据数据页的flag标记，判断是否对数据页进行加密。
5. 读取数据页：根据数据页的flag标记，判断是否对数据页进行解密。
### 实现难点
1. 兼容性
    90多个初始化数据页的地方：astore与ustore、并行回放与极致rto、undo、页面压缩
    20多个落盘数据页的地方：段页式、双写、增量checkpoint
    10多个读取数据页的地方：repair、双写
2. 影响范围广
    直接影响：pgwriter、checkpoint、vacuum/analyze、recovery等机制
    熟读并避免影响：heapam统一接口、buffer pool模块、page格式、fms模块、xlog模块等
3. 密钥传递
    密钥信息存在系统表中，同时page中也需存储密钥信息，因此需要将系统表中的密钥信息传递给page（考虑密钥轮转）
    因为二者层次不同，需引入缓存机制实现密钥传递，保证数据落盘时能从缓存中获取密钥信息。同时，备机回放xlog时，也通过缓存传递密钥
4. 拦截非法操作
    关闭透明加密后，再向加密表写入数据。page init时和read page时拦截

## 1.2 全密态数据库
### 功能
