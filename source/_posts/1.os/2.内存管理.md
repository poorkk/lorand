---
title: 操作系统 2 内存管理
date: 2023-01-01 16:03:37
categories:
    - 操作系统
tags:
    - 操作系统
---

## 概述
### 结构
- 分段
    - 设计
        - 虚拟地址分为若干大小的段
        - 段表存储分段信息
        - 每个进程1个段表，操作系统1个全局段表
    - 实现
        - 虚拟地址为：[段号 + 段内偏移]（段号->段基址 + 段内偏移）
        - 物理地址：以段为单位分配

        ```bash
        - 段表
        --------+--------+--------
        段号    | 段基址  | 段长度
        --------+--------+--------
        0       | 0x...  | 2k  
        1       | 0x...  | 5k
        --------+--------+---------
        ```
    - 优点
        - 逻辑连续
    - 缺点
        - 分段粒度粗，容易产生外部碎片
- 分页
    - 设计
        - 物理内存划分为连续、等长的物理页
        - 虚拟页与物理页大小相等
        - 虚拟页可映射至任意物理页
        - 每个进程1个页表（或1级页表）
    - 实现
        - [虚拟页号 + 页内偏移] 

        ```bash
        - 页表
        --------+----------
        虚拟页号 | 物理页号
        --------+----------
        0       |    10
        1       |    13
        --------+----------
        ```
    - 优点
        - 解决外部碎片
        - 应用程序时空局限性：执行时，使用的数据或代码是连续的
    - 缺点
        - 页表过大（解决：多级页表 -> 剪枝）
            - 多级页表：[虚拟页号_0:虚拟页号_1:虚拟页号_2:虚拟页号_3 + 页内偏移]

    - 优化
        - TLB （性能）
            - 位置：位于CPU内部
            - 功能：缓存虚拟页号到物理页号的映射关系
            - 作用：先查TLB，如果TLB未命中，再查缓存
            - 刷新：切换页表时，刷新全部TLB（优化：TLB缓存项记录页表标签，切换页表时无需全部刷新）
            
            ```bash
            [CPU] --> [TLB] --> [页表]
                    [p3]
                    [p9]
                    [p5]
            ```
            - 结构：根据CPU缓存 L1 L2 L3 分级结构 -> TLB 也是分级结构
        - swapping （大小）
            - 功能：虚拟内存 > 物理内存时，将内存页存放到磁盘
            - 算法：FIFO、LRU/MRU、Clock
        - 缺页异常 （稳定）
            - 原因：物理内存需求过大
            - 处理：等待磁盘IO，将物理页读取至内存
        - 伙伴系统（利用率）
            - 问题：外部碎片：空闲但不连续；内部碎片：分配空间过大
            - 实现：分裂与合并

            ```bash
            - 伙伴系统
            时间1：    [                    ]
            
            时间2：    [         ] [        ]
            
            时间3：    [   ] [   ] 
            ```

            - 空闲链表：较大空间分裂时，将多余的部分移入上一空间数组链表
            ```bash
            - 空闲数组链表
            [ 2^0 ]
            [ 2^1 ] -> [] -> []
            [ 2^2 ] -> []
            ```
        - 写时复制（共享）