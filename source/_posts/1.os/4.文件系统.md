---
title: 操作系统 4 文件系统
date: 2023-01-01 16:03:37
categories:
    - 操作系统
tags:
    - 操作系统
---

- 文件系统
    - ext2
        - 架构
            ```bash
            磁盘
            | 引导  | 
            | 块组1 |         块组 (数据存储在block中)
            | 块组2 | < | 超级块       |
            | 快组. |   | 组描述符 * n | 
            | 块组n |   | 块位图       |
                        | inode位图    |       inode （大小：128 / 256bytes，block数据可能会超过记录至）
                        | inode * n    | <  | 文件类型     |
                        | block * n    |    | 文件大小     |
                                            | 链接数       | 有多少文件名指向此inode
                                            | 文件权限     |
                                            | 时间         | (创建、修改、访问)
                                            | 1级指针 * 12 | -> block （block 为 4k时，最大单一文件为2T，文件系统容量为16T）
                                            | 2级指针 * 1  |
                                            | 3级指针 * 1  |
                                            | 4级指针 * 1  |
            ```
    - 文件系统崩溃一致性
        - 一致性属性
            - 持久化
            - 原子性
            - 有序性
        - 一致性实现
            - 日志
                - 缺点：日志多次读写占用IO
                - 改进：批量写日志 + 检查点
- 设备管理
    - 分类
        - 字符设备：LED、键盘、串口
            - 顺序访问：内次读取一个字符
            - 通过驱动与设备交互
        - 块设备：内存、磁盘、u盘
            - 随机访问：以块粒度进行读写
            - 系统层增加缓冲区，避免与慢设备频繁交互
        - 网络设备：网卡
            - 面向格式化报文的收发
            - 驱动以上维护多种协议
    - 设备管理
        - 字符抽象：文件系统：open/read/write/close
        - 块抽象：文件系统、mmap
        - 网络抽象：socket、文件系统：sockent/send/recv/close
    - CPU与设备交互
        - 可编程IO：cpu的in/out load/store指令
            - 特点
                - 消耗CPU时钟周期 与 数据量成正比
                - 适合于小型设备
            - 分类
                - PIO (port IO)
                    - IO设备具备独立的地址空间
                    - 使用特殊指令 in/out
                - MMIO (Memory-mapped IO)
                    - 将设备映射到连续物理内存中
                    - 使用内存访问指令
                        - 行为与内存不完全一样，读写有副作用
        - 直接内存访问 DMA：外设可直接访问总线
            - 特点
                - DMA与内存交互传输数据，无需CPU参与
                - 适合与高吞吐量IO
            - 结构
                ```bash
                                  [CPU]
                                    |
                                [高速缓存]
                                    | 
                ----+---------------+--------------+--------- 系统总线
                    |                              |
                [DMA控制器]                      [内存]
                    |
                ----+---------------------------------------- PCI总线
                    |
                  [外设]
                ```
            - 读取步骤
                - 1.CPU中驱动发出请求，将设备数据读取至内存地址x
                - 2.外设初始化DMA传递，将数据传送到数据DMA控制器
                - 3.DMA将数据传送至内存地址x
                - 4.DMA传输完成后，向CPU发出中断
                - 5.PU执行每条指令后，检查中断是否到来