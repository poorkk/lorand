---
title: 存储引擎 checkpoint
date: 2022-09-25 16:03:37
categories:
    - 存储引擎
tags:
    - 存储引擎
---

```c
// checkpoint时机
#define CHECKPOINT_IS_SHUTDOWN	0x0001	/* Checkpoint is for shutdown */
#define CHECKPOINT_END_OF_RECOVERY	0x0002 /* end of wal end recovery */
#define CHECKPOINT_IMMEDIATE	0x0004	/* Do it without delays */
#define CHECKPOINT_FORCE		0x0008	/* Force even if no activity */
#define CHECKPOINT_FLUSH_ALL	0x0010	/* Flush all pages, including those belonging to unlogged tables */
/* These are important to RequestCheckpoint */
#define CHECKPOINT_WAIT			0x0020	/* Wait for completion */
/* These indicate the cause of a checkpoint request */
#define CHECKPOINT_CAUSE_XLOG	0x0040	/* XLOG consumption */
#define CHECKPOINT_CAUSE_TIME	0x0080	/* Elapsed time */
```

```c
// checkpoint时机
#define CHECKPOINT_IS_SHUTDOWN	0x0001	/* Checkpoint is for shutdown */
#define CHECKPOINT_END_OF_RECOVERY	0x0002 /* end of wal end recovery */
#define CHECKPOINT_IMMEDIATE	0x0004	/* Do it without delays */
#define CHECKPOINT_FORCE		0x0008	/* Force even if no activity */
#define CHECKPOINT_FLUSH_ALL	0x0010	/* Flush all pages, including those belonging to unlogged tables */
/* These are important to RequestCheckpoint */
#define CHECKPOINT_WAIT			0x0020	/* Wait for completion */
/* These indicate the cause of a checkpoint request */
#define CHECKPOINT_CAUSE_XLOG	0x0040	/* XLOG consumption */
#define CHECKPOINT_CAUSE_TIME	0x0080	/* Elapsed time */

// checkpont实现
CheckpointerMain()
    for (;;) {
        ResetLatch()
        GetInsertRecPtr()
        CreateCheckPoint()
            InitXLogInsert()
            smgrpreckpt()
            GetOldestActiveTransactionId()
            WALInsertLockAcquireExclusive()
            WALInsertLockRelease()
            MultiXactGetCheckptMulti()

            // 先落盘
            CheckPointGuts()
                CheckPointCLOG()
                CheckPointCommitTs()
                CheckPointSUBTRANS()
                CheckPointMultiXact()
                CheckPointPredicate()
                CheckPointRelationMap()
                CheckPointReplicationSlots()
                CheckPointSnapBuild()
                CheckPointLogicalRewriteHeap()
                CheckPointBuffers()
                    BufferSync()
                        while() {
                            SyncOneBuffer()
                                FlushBuffer()
                                    XLogFlush()
                                    smgrwrite()
                        }
                    smgrsync()
                CheckPointReplicationOrigin()
                CheckPointTwoPhase()

            // 再写xlog记录
            XLogBeginInsert()
            XLogRegisterData()
            XLogInsert(RM_XLOG_ID)
            XLogFlush()
            // 最后更新控制文件
            UpdateControlFile()
            smgrpostckpt()

        smgrcloseall()

        CheckArchiveTimeout()
        pgstat_send_bgwriter()
        WaitLatch()
    }

// BufferSync
```
