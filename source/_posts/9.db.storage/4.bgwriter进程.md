---
title: 存储引擎 bgwriter进程
date: 2022-09-25 16:03:37
categories:
    - 存储引擎
tags:
    - 存储引擎
---

# 1 启动流程
bgwritere与checkpoint的区别：
目的不同，执行频率不同
1. checkpoint定期执行，除共享缓冲区中的数据页外，还会落盘事务日志等信息，并向xlog日志checkpoint检查点
2. bgwriter定期执行，刷写部分脏页，同时执行缓存替换算法，保证缓冲区管理器页面充足，降低postgres进程等待缓冲区空闲的概率

bgwriter设置参数：
- bgwriter_delay：定期执行刷盘操作
- bgwriter_lru_multiplier (M)：两次bgwriter刷盘之间申请的page页数为N，系统最多写出M x N个脏页
- bgwriter_lru_maxpages：写出脏页最大数

postgres会做时钟扫描算法，bgwriter要跟上时钟扫描算法

启动流程：
```c
ServerLoop()
    StartBackgroundWriter()
        StartChildProcess()
            AuxiliaryProcessMain()
                BackgroundWriterMain()         
```

整体步骤：
1. 初始化内存上下文
2. 

```c
+------+
| 1    |
| 2    | <- 上次bgwriter位置
| 3    |
| 4    | <- 时钟扫描位置
| 5    |
| 6    | <- 申请的buffer
| ...  |
| 1024 |
+------+
```

```c
BackgroundWriterMain()
    /* 内存上下文 */
    AllocSetContextCreate(TopMemoryContext)

    /* 循环 */
    for (;;) {
        ResetLatch()
       
       /* 1. 遍历所有脏页，写入磁盘，记录统计信息 */
        BgBufferSync()
            /* 找到时钟扫描受害者位置，计算上次时钟扫描到目前申请的buffer */
            StrategySyncStart()

            
            while (num_to_scan > 0 && reusable_buffers < upcoming_alloc_est)
                SyncOneBuffer()
                    FlushBuffer(bufHdr, NULL);
        
        /* 2. 将统计信息发送给pgstat进程 */
        pgstat_send_bgwriter()

        WaitLatch()
            WaitLatchOrSocket()
               select() 
   }
```