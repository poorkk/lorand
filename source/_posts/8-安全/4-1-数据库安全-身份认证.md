---
title: 数据库安全 1 身份认证
categories:
    - 安全
tags:
    - 安全
---

> **摘要**：从5个方面，介绍PostgreSQL身份认证特性：背景、原理、使用、设计、实现

# 1 身份认证概述

数据库运行时，为避免非法用户访问数据库，造成数据损坏、数据泄露等问题，需采用身份认证机制，阻拦非法用户访问数据库。
身份认证分为标识与鉴别，标识指如何定义合法用户与非法用户，鉴别指根据用户标识判断用户身份。
数据库在建立连接阶段提供三层身份认证机制。

- 原理：比较常见的概念，提供账号和密码，才能登录系统，执行其他操作
- 背景：
    - 服务器：因为数据库本身也是一个服务器，监听特定端口，谁都可以建立TCP连接，要区分是非法用户，还是合法用户
    - PG：稍微复杂一点点，支持基于主机的身份认证，不同的IP，采用不同的认证方式
- 从用户的角度
    1. 创建用户：生成账号、设置账号密码
    2. 主机认证：针对不同的IP，设置不同的认证方式
    3. 连接数据库：使用账号、密码，连接数据库。如果账号和密码正确，才能连接，然后执行SQL和其他操作
- 从实现的角度
    1. 创建用户：支持语法，存储密码。密码存在系统表中，不能直接存储密码明文，而是存哈希值
    2. 主机认证：解析配置参数，不同的ip，使用不同的认证方式
    3. 连接数据库：密码不能直接传，有个交互过程，有个标准格式，传输密码的hash值
- 我的工作：
    - 密码的hash值，是密码学中的hash算法，支持国密算法
        - 配置、交互过程等有简单适配

## 2.1 基于IP的身份认证
标识：访问者的IP
鉴别：数据库遍历IP白名单，判断访问者IP是否在白名单中，如果在，则认为访问者合法，允许与数据建立TCP连接。
```c
PostmasterMain
    ServerLoop
        ConnCreate
            StreamConnection
        BackendStartup
            BackendRun
                PostgresMain
                    InitPostgres
                        PerformAuthentication
                            ClientAuthentication
                                hba_getauthmethod /* 从hba文件中，获取指定ip的认证方式 */
                                    check_hba
                                        check_hostname
                                        check_ip
                                        /* 如果指定ip未获取到认证方式，则返回空 */
                                switch hba->auth_method: /* 根据ip采用不同的认证方式 */
                                    case uaReject:
                                    case uaImplicitReject:
                                    case uaGSS:
                                    case uaSSPI:
                                    case uaPeer:
                                    ...
                                    case uaMD5:
                                    case uaPassword:
                                    case uaCert:
                                    case uaTrust:
                                    ...
```

## 2.2 基于证书的身份认证
通常，应用与数据库通信时，先采用SSL协议建立安全的通信信道。在建立SSL阶段，数据库可要求应用提供证书，数据库验证应用证书后，才与其建立SSL连接。该场景中，身份标识即证书，身份鉴别即校验证书的合法性。
标识：证书
鉴别：数据库使用CA的公钥，判断访问者的证书是否由CA签名，如果是，则认为访问者合法，允许与数据建立SSL连接


## 2.3 基于密码的身份认证
应用与数据库建立连接后，还需再进行一次身份认证。身份标识即数据库用户与密码，身份鉴别即判断用户与密码是否匹配。
标识：用户与密码
鉴别：数据库访问pg_role系统表，判断访问者的密码哈希是否与系统表中的密码哈希一致，如果是，则认为访问者合法，允许与数据库建立会话。

创建主体的语法示例如下：
```sql
CREATE USER r1 PASSWORD 'r1@12345';
```
主体信息存在2个系统表中，pg_authid中存储了所有主体的oid
```sql
-- 查询系统表
SELECT oid,rolname,rolpassword FROM pg_authid;
oid   | rolename | rolpassword
------+----------+--------------
16384 | r1       | md5.........

-- 查询视图与查询pg_authid结果一致
SELECT * FROM pg_roles;
SELECT * FROM pg_user;
```

### 3.2.2 客体
客体有多种，本文以最常见的表为例。创建主体的语法示例如下：
```sql
CREATE TABLE t1 (c1 INT);
```
不同客体由不同的系统表，这些系统表中均有ACL、客体属主这2个关键字段。ACL字段默认为空，在鉴权时，如果ACL为空，会认为属主有全部权限。属主即创建客体的用户。
不同客体及对应的系统表如下：
```sql
-- 数据库
SELECT oid,datname,datdba,datacl FROM pg_database;
  oid  |  datname  | datdba |            datacl
-------+-----------+--------+-------------------------------
 12295 | postgres  |     10 |

-- 表空间
SELECT oid,spcname,spcowner,spcacl FROM pg_tablespace;
 oid  |  spcname   | spcowner | spcacl 
------+------------+----------+--------
 1663 | pg_default |       10 |

-- 表
SELECT oid,relname,relowner,relacl FROM pg_class;
  oid  | relname | relowner | relacl
-------+---------+----------+--------
 16386 | t1      |    16384 |

-- 列
SELECT attrelid,attname,attacl FROM pg_attribute;
 attrelid | attname | attacl
----------+---------+--------
    16386 | c1      |

-- 其他客体不一一介绍，通过以下语法，可查询哪些客体的系统表有ACL字段
SELECT attrelid::regclass,attname FROM pg_attribute WHERE attname LIKE '%acl%';
```