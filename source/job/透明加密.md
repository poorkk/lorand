
pg-internal.vonng.com

进程架构：
- postmaster
- postgres
- wal writer
- background writer
- checkpointer
- autovacuum
- statistics collector：收集统计信息
- archiver：日志归档
- logging collertor：日志

启动辅助进程
```c
#define StartupDataBase()		StartChildProcess(StartupProcess)
#define StartBackgroundWriter() StartChildProcess(BgWriterProcess)
#define StartCheckpointer()		StartChildProcess(CheckpointerProcess)
#define StartWalWriter()		StartChildProcess(WalWriterProcess)
#define StartWalReceiver()		StartChildProcess(WalReceiverProcess)

main()
    PostmasterMain()
        pqsignal(SIGUSR1, sigusr1_handler);
        SysLogger_Start()
        StartupDataBase() -> StartupProcessMain()
        ServerLoop()
            BackendStartup()
            SysLogger_Start()
            StartCheckpointer() -> CheckpointerMain()
            StartBackgroundWriter() -> BackgroundWriterMain()
            StartWalWriter() -> InitXLOGAccess() WalWriterMain()
            StartAutoVacLauncher()
            pgstat_start()
            pgarch_start()
            maybe_start_bgworker()

WaitForWALToBecomeAvailable()
    RequestXLogStreaming()
        SendPostmasterSignal(PMSIGNAL_START_WALRECEIVER)
sigusr1_handler(PMSIGNAL_START_WALRECEIVER)
    StartWalReceiver()

StartChildProcess()
    AuxiliaryProcessMain()
        WalWriterMain()
        ...
```

启动进程
```c
StartupProcessMain()
    StartupXLOG()
```

WAL写进程
### 启动
```c
InitXLOGAccess()
    GetRedoRecPtr()
        RedoRecPtr = XLogCtl->RedoRecPtr
    InitXLogInsert() // 初始化内存
WalWriterMain()
    for (;;)
        XLogBackgroundFlush()
            LWLockAcquire(WALWriteLock)
            XLogWrite()
                curridx = XLogRecPtrToBufIdx(LogwrtResult.Write) // 找到上一次xlog点
                while (LogwrtResult.Write < WriteRqst.Write) // 计算长度，计算完成后才开始写入
                    XLogRecPtr EndPtr = XLogCtl->xlblocks[curridx];
                    LogwrtResult.Write = EndPtr; // 实时更新落盘位置
                    startidx = curridx;
                    npage++;
                    from = XLogCtl->pages + startidx * (Size) XLOG_BLCKSZ; // 计算落盘长度，BLKCZ可配置，1k到6m
                    if WriteRqst.Write <= LogwrtResult.Write:
                        write(from, npages * (Size) XLOG_BLCKSZ)
                        WalSndWakeupRequest()
                        XLogArchiveNotifySeg()
                        if (XLogCheckpointNeeded):
                            RequestCheckpoint(CHECKPOINT_CAUSE_XLOG)
                curridx = NextBufIdx(curridx)
            WalSndWakeupProcessRequests()
                WalSndWakeup()
            AdvanceXLInsertBuffer() // 扩张wal
        WaitLatch(WalWriterDelay)
            WaitLatchOrSocket()
                select() /* sleep */
```
### 接口
```c
/* 插入 */
XLogRecPtr XLogInsertRecord(struct XLogRecData *rdata, XLogRecPtr fpw_lsn)
/* 落盘 */
XLogFlush(XLogRecPtr RecPtr)
xlog_redo(XLogReaderState *record)

XLogRecPtr GetXLogReplayRecPtr()
XLogRecPtr GetXLogInsertRecPtr()
XLogRecPtr GetXLogWriteRecPtr()

UpdateControlFile()

StartupXLOG()
ShutdownXLOG()
WakeupRecovery()
```
